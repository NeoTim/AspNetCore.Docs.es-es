---
title: Migración desde ASP.NET Core 2,2 a la versión preliminar de 3,0
author: rick-anderson
description: Obtenga información sobre cómo migrar un proyecto ASP.NET Core 2,2 a ASP.NET Core 3,0.
ms.author: riande
ms.custom: mvc
ms.date: 09/06/2019
uid: migration/22-to-30
ms.openlocfilehash: f5ac089918fa8fbe42dec8aa34b1223c0c6a0adf
ms.sourcegitcommit: f65d8765e4b7c894481db9b37aa6969abc625a48
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/06/2019
ms.locfileid: "70773639"
---
# <a name="migrate-from-aspnet-core-22-to-30"></a><span data-ttu-id="412ac-103">Migrar de ASP.NET Core 2,2 a 3,0</span><span class="sxs-lookup"><span data-stu-id="412ac-103">Migrate from ASP.NET Core 2.2 to 3.0</span></span>

<span data-ttu-id="412ac-104">Por [Scott Addie](https://github.com/scottaddie) y [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="412ac-104">By [Scott Addie](https://github.com/scottaddie) and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

<span data-ttu-id="412ac-105">En este artículo se explica cómo actualizar un proyecto ASP.NET Core 2,2 existente a ASP.NET Core 3,0.</span><span class="sxs-lookup"><span data-stu-id="412ac-105">This article explains how to update an existing ASP.NET Core 2.2 project to ASP.NET Core 3.0.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="412ac-106">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="412ac-106">Prerequisites</span></span>

# <a name="visual-studiotabvisual-studio"></a>[<span data-ttu-id="412ac-107">Visual Studio</span><span class="sxs-lookup"><span data-stu-id="412ac-107">Visual Studio</span></span>](#tab/visual-studio)

[!INCLUDE[](~/includes/net-core-prereqs-vs-3.0.md)]

# <a name="visual-studio-codetabvisual-studio-code"></a>[<span data-ttu-id="412ac-108">Visual Studio Code</span><span class="sxs-lookup"><span data-stu-id="412ac-108">Visual Studio Code</span></span>](#tab/visual-studio-code)

[!INCLUDE[](~/includes/net-core-prereqs-vsc-3.0.md)]

# <a name="visual-studio-for-mactabvisual-studio-mac"></a>[<span data-ttu-id="412ac-109">Visual Studio para Mac</span><span class="sxs-lookup"><span data-stu-id="412ac-109">Visual Studio for Mac</span></span>](#tab/visual-studio-mac)

[!INCLUDE[](~/includes/net-core-prereqs-mac-3.0.md)]

---

## <a name="update-the-project-file"></a><span data-ttu-id="412ac-110">Actualizar el archivo de proyecto</span><span class="sxs-lookup"><span data-stu-id="412ac-110">Update the project file</span></span>

* <span data-ttu-id="412ac-111">Establezca el [moniker de la plataforma de destino (TFM)](/dotnet/standard/frameworks) en `netcoreapp3.0`:</span><span class="sxs-lookup"><span data-stu-id="412ac-111">Set the [Target Framework Moniker (TFM)](/dotnet/standard/frameworks) to `netcoreapp3.0`:</span></span>

  ```xml
  <TargetFramework>netcoreapp3.0</TargetFramework>
  ```

* <span data-ttu-id="412ac-112">Quite cualquier `<PackageReference>` del metapaquete [Microsoft. AspNetCore. All](xref:fundamentals/metapackage) o [Microsoft. AspNetCore. app](xref:fundamentals/metapackage-app) .</span><span class="sxs-lookup"><span data-stu-id="412ac-112">Remove any `<PackageReference>` to the [Microsoft.AspNetCore.All](xref:fundamentals/metapackage) or [Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app) metapackage.</span></span>

* <span data-ttu-id="412ac-113">Quite cualquier `<PackageReference>` del paquete [Microsoft. AspNetCore. Razor. Design](https://www.nuget.org/packages/Microsoft.AspNetCore.Razor.Design/) .</span><span class="sxs-lookup"><span data-stu-id="412ac-113">Remove any `<PackageReference>` to the [Microsoft.AspNetCore.Razor.Design](https://www.nuget.org/packages/Microsoft.AspNetCore.Razor.Design/) package.</span></span>

* <span data-ttu-id="412ac-114">Si la aplicación usa [analizadores de API](xref:web-api/advanced/analyzers), quite `<PackageReference>` cualquier elemento del paquete [Microsoft. AspNetCore. Mvc. API. analizadores](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Api.Analyzers/) .</span><span class="sxs-lookup"><span data-stu-id="412ac-114">If your application uses [API analyzers](xref:web-api/advanced/analyzers), remove any `<PackageReference>` element for the [Microsoft.AspNetCore.Mvc.Api.Analyzers](https://www.nuget.org/packages/Microsoft.AspNetCore.Mvc.Api.Analyzers/) package.</span></span> <span data-ttu-id="412ac-115">Edite el archivo de proyecto para usar el analizador incluido como parte de la SDK de .NET Core:</span><span class="sxs-lookup"><span data-stu-id="412ac-115">Edit your project file to use the analyzer shipped as part of the .NET Core SDK:</span></span>

```xml
<PropertyGroup>
 <IncludeOpenAPIAnalyzers>true</IncludeOpenAPIAnalyzers>
</PropertyGroup>
```

* <span data-ttu-id="412ac-116">Actualice el `Version` atributo en los `<PackageReference>` elementos restantes `Microsoft.AspNetCore.*` de los paquetes a la vista previa actual ( `3.0.0-preview5-19227-01`por ejemplo,).</span><span class="sxs-lookup"><span data-stu-id="412ac-116">Update the `Version` attribute on remaining `<PackageReference>` elements for `Microsoft.AspNetCore.*` packages to the current preview (for example, `3.0.0-preview5-19227-01`).</span></span>

  <span data-ttu-id="412ac-117">Si no hay ninguna versión 3,0 de un paquete, es posible que el paquete esté en desuso en 3,0.</span><span class="sxs-lookup"><span data-stu-id="412ac-117">If there's no 3.0 version of a package, the package might have been deprecated in 3.0.</span></span> <span data-ttu-id="412ac-118">Muchos de estos paquetes forman parte de `Microsoft.AspNetCore.App` y no se debe hacer referencia a ellos de forma individual.</span><span class="sxs-lookup"><span data-stu-id="412ac-118">Many of these packages are part of `Microsoft.AspNetCore.App` and shouldn't be referenced individually.</span></span> <span data-ttu-id="412ac-119">Para obtener una lista preliminar de los paquetes que ya no se producen en 3,0, consulte [detener la generación de paquetes para ensamblados de marco compartidos en 3,0 (ASPNET/AspNetCore #3756)](https://github.com/aspnet/AspNetCore/issues/3756).</span><span class="sxs-lookup"><span data-stu-id="412ac-119">For a preliminary list of packages no longer produced in 3.0, see [Stop producing packages for shared framework assemblies in 3.0 (aspnet/AspNetCore #3756)](https://github.com/aspnet/AspNetCore/issues/3756).</span></span> <span data-ttu-id="412ac-120">El *marco de trabajo compartido* es el conjunto de ensamblados (archivos *. dll* ) que están instalados en el equipo y `Microsoft.AspNetCore.App`a los que hace referencia.</span><span class="sxs-lookup"><span data-stu-id="412ac-120">The *shared framework* is the set of assemblies (*.dll* files) that are installed on the machine and referenced by `Microsoft.AspNetCore.App`.</span></span> <span data-ttu-id="412ac-121">Para más información, consulte este artículo sobre el [marco de trabajo compartido](https://natemcmaster.com/blog/2018/08/29/netcore-primitives-2/).</span><span class="sxs-lookup"><span data-stu-id="412ac-121">For more information, see [The shared framework](https://natemcmaster.com/blog/2018/08/29/netcore-primitives-2/).</span></span>

* <span data-ttu-id="412ac-122">Los ensamblados de varios componentes importantes se quitaron de `Microsoft.AspNetCore.App` en 3,0.</span><span class="sxs-lookup"><span data-stu-id="412ac-122">The assemblies for several notable components were removed from `Microsoft.AspNetCore.App` in 3.0.</span></span> <span data-ttu-id="412ac-123">Agregue `<PackageReference>` elementos si usa las API de los paquetes enumerados en [ensamblados que se van a quitar de Microsoft. AspNetCore. app 3,0 (ASPNET/AspNetCore #3755)](https://github.com/aspnet/AspNetCore/issues/3755).</span><span class="sxs-lookup"><span data-stu-id="412ac-123">Add `<PackageReference>` elements if you're using APIs from packages listed in [Assemblies being removed from Microsoft.AspNetCore.App 3.0 (aspnet/AspNetCore #3755)](https://github.com/aspnet/AspNetCore/issues/3755).</span></span>

  <span data-ttu-id="412ac-124">Entre los ejemplos de componentes quitados se incluyen:</span><span class="sxs-lookup"><span data-stu-id="412ac-124">Examples of removed components include:</span></span>

  * `Microsoft.AspNet.WebApi.Client`
  * `Microsoft.EntityFrameworkCore`
  * `System.Data.SqlClient`

  <span data-ttu-id="412ac-125">La lista de ensamblados que `Microsoft.AspNetCore.App` se distribuyen en no se ha finalizado y cambiará antes 3,0 RTM.</span><span class="sxs-lookup"><span data-stu-id="412ac-125">The list of assemblies shipping in `Microsoft.AspNetCore.App` hasn't been finalized and will change before 3.0 RTM.</span></span>

  <span data-ttu-id="412ac-126">Observe el código siguiente:</span><span class="sxs-lookup"><span data-stu-id="412ac-126">Consider the following code:</span></span>

  ```csharp
  var branches = await response.Content.ReadAsAsync<IEnumerable<GitHubBranch>>();
  ```

  <span data-ttu-id="412ac-127">El `ReadAsAsync` método al que se llama en el código anterior `Microsoft.AspNet.WebApi.Client`se incluye en.</span><span class="sxs-lookup"><span data-stu-id="412ac-127">The `ReadAsAsync` method called in the preceding code is included in `Microsoft.AspNet.WebApi.Client`.</span></span> <span data-ttu-id="412ac-128">Instale el paquete NuGet [Microsoft. Aspnet. WebApi. Client](https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Client/) para resolver el problema de compilación en 3,0.</span><span class="sxs-lookup"><span data-stu-id="412ac-128">Install the [Microsoft.AspNet.WebApi.Client](https://www.nuget.org/packages/Microsoft.AspNet.WebApi.Client/) NuGet package to resolve the compilation issue in 3.0.</span></span>

* <span data-ttu-id="412ac-129">Agregue [compatibilidad con JSON.net](#jsonnet-support).</span><span class="sxs-lookup"><span data-stu-id="412ac-129">Add [Json.NET support](#jsonnet-support).</span></span>

* <span data-ttu-id="412ac-130">Los proyectos tienen como valor predeterminado el [modelo de hospedaje en proceso](xref:host-and-deploy/aspnet-core-module#in-process-hosting-model) en ASP.net Core 3,0 o posterior.</span><span class="sxs-lookup"><span data-stu-id="412ac-130">Projects default to the [in-process hosting model](xref:host-and-deploy/aspnet-core-module#in-process-hosting-model) in ASP.NET Core 3.0 or later.</span></span> <span data-ttu-id="412ac-131">Opcionalmente, puede quitar la `<AspNetCoreHostingModel>` propiedad en el archivo de proyecto si su valor `InProcess`es.</span><span class="sxs-lookup"><span data-stu-id="412ac-131">You may optionally remove the `<AspNetCoreHostingModel>` property in the project file if its value is `InProcess`.</span></span>

## <a name="jsonnet-support"></a><span data-ttu-id="412ac-132">Compatibilidad con Json.NET</span><span class="sxs-lookup"><span data-stu-id="412ac-132">Json.NET support</span></span>

<span data-ttu-id="412ac-133">Como parte del trabajo para [mejorar la ASP.net Core marco compartido](https://blogs.msdn.microsoft.com/webdev/2018/10/29/a-first-look-at-changes-coming-in-asp-net-core-3-0/), se ha quitado [Json.NET](https://www.newtonsoft.com/json/help/html/Introduction.htm) de la ASP.net Core marco compartido.</span><span class="sxs-lookup"><span data-stu-id="412ac-133">As part of the work to [improve the ASP.NET Core shared framework](https://blogs.msdn.microsoft.com/webdev/2018/10/29/a-first-look-at-changes-coming-in-asp-net-core-3-0/), [Json.NET](https://www.newtonsoft.com/json/help/html/Introduction.htm) has been removed from the ASP.NET Core shared framework.</span></span>

<span data-ttu-id="412ac-134">Para usar Json.NET en un proyecto ASP.NET Core 3,0:</span><span class="sxs-lookup"><span data-stu-id="412ac-134">To use Json.NET in an ASP.NET Core 3.0 project:</span></span>

* <span data-ttu-id="412ac-135">Agregue una referencia de paquete a [Microsoft.AspNetCore.Mvc.NewtonsoftJson](https://nuget.org/packages/Microsoft.AspNetCore.Mvc.NewtonsoftJson).</span><span class="sxs-lookup"><span data-stu-id="412ac-135">Add a package reference to [Microsoft.AspNetCore.Mvc.NewtonsoftJson](https://nuget.org/packages/Microsoft.AspNetCore.Mvc.NewtonsoftJson).</span></span>
* <span data-ttu-id="412ac-136">Actualización `Startup.ConfigureServices` que se `AddNewtonsoftJson`va a llamar.</span><span class="sxs-lookup"><span data-stu-id="412ac-136">Update `Startup.ConfigureServices` to call `AddNewtonsoftJson`.</span></span>

  ```csharp
  services.AddMvc()
      .AddNewtonsoftJson();
  ```
  
  <span data-ttu-id="412ac-137">`AddNewtonsoftJson`es compatible con los nuevos métodos de registro del servicio MVC:</span><span class="sxs-lookup"><span data-stu-id="412ac-137">`AddNewtonsoftJson` is compatible with the new MVC service registration methods:</span></span>

  * `AddRazorPages`
  * `AddControllersWithViews`
  * `AddControllers`

  ```csharp
  services.AddControllers()
      .AddNewtonsoftJson();
  ```

  <span data-ttu-id="412ac-138">La configuración de Json.NET se puede establecer en la `AddNewtonsoftJson`llamada a:</span><span class="sxs-lookup"><span data-stu-id="412ac-138">Json.NET settings can be set in the call to `AddNewtonsoftJson`:</span></span>

  ```csharp
  services.AddMvc()
      .AddNewtonsoftJson(options =>
             options.SerializerSettings.ContractResolver =
                new CamelCasePropertyNamesContractResolver());
  ```

## <a name="mvc-service-registration"></a><span data-ttu-id="412ac-139">Registro del servicio MVC</span><span class="sxs-lookup"><span data-stu-id="412ac-139">MVC service registration</span></span>

<span data-ttu-id="412ac-140">ASP.NET Core 3,0 agrega nuevas opciones para registrar escenarios MVC en `Startup.ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="412ac-140">ASP.NET Core 3.0 adds new options for registering MVC scenarios inside `Startup.ConfigureServices`.</span></span>

<span data-ttu-id="412ac-141">Hay disponibles tres nuevos métodos de extensión de nivel superior relacionados con `IServiceCollection` los escenarios MVC en.</span><span class="sxs-lookup"><span data-stu-id="412ac-141">Three new top-level extension methods related to MVC scenarios on `IServiceCollection` are available.</span></span> <span data-ttu-id="412ac-142">Las plantillas usan estos nuevos métodos en lugar `UseMvc`de.</span><span class="sxs-lookup"><span data-stu-id="412ac-142">Templates use these new methods instead of `UseMvc`.</span></span> <span data-ttu-id="412ac-143">Sin embargo `AddMvc` , continúa comportándose como tiene en versiones anteriores.</span><span class="sxs-lookup"><span data-stu-id="412ac-143">However, `AddMvc` continues to behave as it has in previous releases.</span></span>

<span data-ttu-id="412ac-144">En el ejemplo siguiente se agrega compatibilidad con controladores y características relacionadas con la API, pero no vistas o páginas.</span><span class="sxs-lookup"><span data-stu-id="412ac-144">The following example adds support for controllers and API-related features, but not views or pages.</span></span> <span data-ttu-id="412ac-145">La plantilla de API usa este código:</span><span class="sxs-lookup"><span data-stu-id="412ac-145">The API template uses this code:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();
}
```

<span data-ttu-id="412ac-146">En el ejemplo siguiente se agrega compatibilidad con controladores, características relacionadas con la API y vistas, pero no páginas.</span><span class="sxs-lookup"><span data-stu-id="412ac-146">The following example adds support for controllers, API-related features, and views, but not pages.</span></span> <span data-ttu-id="412ac-147">La plantilla aplicación web (MVC) utiliza este código:</span><span class="sxs-lookup"><span data-stu-id="412ac-147">The Web Application (MVC) template uses this code:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllersWithViews();
}
```

<span data-ttu-id="412ac-148">En el ejemplo siguiente se agrega compatibilidad con Razor Pages y compatibilidad mínima con el controlador.</span><span class="sxs-lookup"><span data-stu-id="412ac-148">The following example adds support for Razor Pages and minimal controller support.</span></span> <span data-ttu-id="412ac-149">La plantilla de aplicación Web usa este código:</span><span class="sxs-lookup"><span data-stu-id="412ac-149">The Web Application template uses this code:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddRazorPages();
}
```

<span data-ttu-id="412ac-150">También se pueden combinar los nuevos métodos.</span><span class="sxs-lookup"><span data-stu-id="412ac-150">The new methods can also be combined.</span></span> <span data-ttu-id="412ac-151">El ejemplo siguiente es equivalente a llamar `AddMvc` a en ASP.net Core 2,2:</span><span class="sxs-lookup"><span data-stu-id="412ac-151">The following example is equivalent to calling `AddMvc` in ASP.NET Core 2.2:</span></span> 

```csharp
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllers();
    services.AddRazorPages();
}
```

## <a name="update-routing-startup-code"></a><span data-ttu-id="412ac-152">Actualizar código de inicio de enrutamiento</span><span class="sxs-lookup"><span data-stu-id="412ac-152">Update routing startup code</span></span>

<span data-ttu-id="412ac-153">Si una aplicación llama `UseMvc` a `UseSignalR`o, migre la aplicación al [enrutamiento del punto de conexión](xref:fundamentals/routing) , si es posible.</span><span class="sxs-lookup"><span data-stu-id="412ac-153">If an app calls `UseMvc` or `UseSignalR`, migrate the app to [Endpoint Routing](xref:fundamentals/routing) if possible.</span></span> <span data-ttu-id="412ac-154">Para mejorar la compatibilidad del enrutamiento de puntos de conexión con versiones anteriores de MVC, hemos revertido algunos de los cambios en la generación de direcciones URL introducidos en ASP.NET Core 2,2.</span><span class="sxs-lookup"><span data-stu-id="412ac-154">To improve Endpoint Routing compatibility with previous versions of MVC, we've reverted some of the changes in URL generation introduced in ASP.NET Core 2.2.</span></span> <span data-ttu-id="412ac-155">Si experimenta problemas al usar el enrutamiento de puntos de conexión en 2,2, espere mejoras en ASP.NET Core 3,0 con las siguientes excepciones:</span><span class="sxs-lookup"><span data-stu-id="412ac-155">If you experienced problems using Endpoint Routing in 2.2, expect improvements in ASP.NET Core 3.0 with the following exceptions:</span></span>

* <span data-ttu-id="412ac-156">Si la aplicación implementa `IRouter` o hereda de `Route`, puede que desee evitar la migración en este momento.</span><span class="sxs-lookup"><span data-stu-id="412ac-156">If the app implements `IRouter` or inherits from `Route`, you may want to avoid migrating at this time.</span></span> <span data-ttu-id="412ac-157">Proporcione comentarios en el [plan para migrar las implementaciones basadas en IRouter al enrutamiento del punto de conexión](https://github.com/aspnet/AspNetCore/issues/4221).</span><span class="sxs-lookup"><span data-stu-id="412ac-157">Provide feedback at [Plan to migrate IRouter based implementations onto Endpoint Routing](https://github.com/aspnet/AspNetCore/issues/4221).</span></span>

* <span data-ttu-id="412ac-158">Si la aplicación accede directamente a `RouteData.Routers` MVC, puede que desee evitar la migración en este momento.</span><span class="sxs-lookup"><span data-stu-id="412ac-158">If the app directly accesses `RouteData.Routers` inside MVC, you may want to avoid migrating at this time.</span></span> <span data-ttu-id="412ac-159">Proporcione comentarios en la [Guía de migración para el uso de RouteData. enrutadores](https://github.com/aspnet/AspNetCore/issues/9148).</span><span class="sxs-lookup"><span data-stu-id="412ac-159">Provide feedback at [Migration guidance for using RouteData.Routers](https://github.com/aspnet/AspNetCore/issues/9148).</span></span>

<span data-ttu-id="412ac-160">El enrutamiento de puntos de conexión admite la misma sintaxis de patrón de ruta y `IRouter`características de creación de patrones de ruta que.</span><span class="sxs-lookup"><span data-stu-id="412ac-160">Endpoint Routing supports the same route pattern syntax and route pattern authoring features as `IRouter`.</span></span> <span data-ttu-id="412ac-161">El enrutamiento del `IRouteContraint`extremo admite.</span><span class="sxs-lookup"><span data-stu-id="412ac-161">Endpoint Routing supports `IRouteContraint`.</span></span> <span data-ttu-id="412ac-162">El enrutamiento del `[Route]`punto `[HttpGet]`de conexión admite, y los demás atributos de enrutamiento de MVC.</span><span class="sxs-lookup"><span data-stu-id="412ac-162">Endpoint routing supports `[Route]`, `[HttpGet]`, and the other MVC routing attributes.</span></span>

<span data-ttu-id="412ac-163">Para la mayoría de las `Startup` aplicaciones, solo requiere cambios.</span><span class="sxs-lookup"><span data-stu-id="412ac-163">For most applications, only `Startup` requires changes.</span></span>

### <a name="migrate-startupconfigure"></a><span data-ttu-id="412ac-164">Migrar startup. Configure</span><span class="sxs-lookup"><span data-stu-id="412ac-164">Migrate Startup.Configure</span></span>

<span data-ttu-id="412ac-165">Consejos generales:</span><span class="sxs-lookup"><span data-stu-id="412ac-165">General advice:</span></span>

* <span data-ttu-id="412ac-166">Agregar `UseRouting`.</span><span class="sxs-lookup"><span data-stu-id="412ac-166">Add `UseRouting`.</span></span> 
* <span data-ttu-id="412ac-167">Si la aplicación llama `UseStaticFiles`a, `UseStaticFiles` Coloque **antes** `UseRouting`de.</span><span class="sxs-lookup"><span data-stu-id="412ac-167">If the app calls `UseStaticFiles`, place `UseStaticFiles` **before** `UseRouting`.</span></span>
* <span data-ttu-id="412ac-168">Si la aplicación usa características de autenticación y autorización como `AuthorizePage` o `[Authorize]`, coloque la llamada a `UseAuthentication` y `UseAuthorization` **después** `UseRouting` de (y **después** `UseCors` de usar el middleware de CORS).</span><span class="sxs-lookup"><span data-stu-id="412ac-168">If the app uses authentication/authorization features such as `AuthorizePage` or `[Authorize]`, place the call to `UseAuthentication` and `UseAuthorization` **after** `UseRouting` (and **after** `UseCors` if CORS Middleware is used).</span></span>
* <span data-ttu-id="412ac-169">Reemplace `UseMvc` o `UseSignalR` por .`UseEndpoints`</span><span class="sxs-lookup"><span data-stu-id="412ac-169">Replace `UseMvc` or `UseSignalR` with `UseEndpoints`.</span></span>
* <span data-ttu-id="412ac-170">Si la aplicación usa escenarios de [CORS](xref:security/cors) , como `[EnableCors]`, coloque la llamada a `UseCors` antes de cualquier otro middleware que use CORS (por ejemplo, coloque `UseCors` antes `UseAuthentication`, `UseAuthorization`y `UseMvc`).</span><span class="sxs-lookup"><span data-stu-id="412ac-170">If the app uses [CORS](xref:security/cors) scenarios, such as `[EnableCors]`, place the call to `UseCors` before any other middlewares that use CORS (for example, place `UseCors` before `UseAuthentication`, `UseAuthorization`, and `UseMvc`).</span></span>
* <span data-ttu-id="412ac-171">Reemplace `IHostingEnvironment` `using` <xref:Microsoft.Extensions.Hosting?displayProperty=fullName> por `IWebHostEnvironment` y agregue una instrucción para el espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="412ac-171">Replace `IHostingEnvironment` with `IWebHostEnvironment` and add a `using` statement for the <xref:Microsoft.Extensions.Hosting?displayProperty=fullName> namespace.</span></span>
* <span data-ttu-id="412ac-172">Reemplazar `IApplicationLifetime` por <xref:Microsoft.Extensions.Hosting.IHostApplicationLifetime> (<xref:Microsoft.Extensions.Hosting?displayProperty=fullName> espacio de nombres).</span><span class="sxs-lookup"><span data-stu-id="412ac-172">Replace `IApplicationLifetime` with <xref:Microsoft.Extensions.Hosting.IHostApplicationLifetime> (<xref:Microsoft.Extensions.Hosting?displayProperty=fullName> namespace).</span></span>
* <span data-ttu-id="412ac-173">Reemplazar `EnvironmentName` por <xref:Microsoft.Extensions.Hosting.Environments> (<xref:Microsoft.Extensions.Hosting?displayProperty=fullName> espacio de nombres).</span><span class="sxs-lookup"><span data-stu-id="412ac-173">Replace `EnvironmentName` with <xref:Microsoft.Extensions.Hosting.Environments> (<xref:Microsoft.Extensions.Hosting?displayProperty=fullName> namespace).</span></span>

<span data-ttu-id="412ac-174">El siguiente es un ejemplo de `Startup.Configure` en una aplicación típica de ASP.net Core 2,2:</span><span class="sxs-lookup"><span data-stu-id="412ac-174">The following is an example of `Startup.Configure` in a typical ASP.NET Core 2.2 app:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseStaticFiles();
    
    app.UseAuthentication();

    app.UseSignalR(hubs =>
    {
        hubs.MapHub<ChatHub>("/chat");
    });

    app.UseMvc(routes =>
    {
        routes.MapRoute("default", "{controller=Home}/{action=Index}/{id?}");
    });
}
```

<span data-ttu-id="412ac-175">Después de actualizar el `Startup.Configure` código anterior:</span><span class="sxs-lookup"><span data-stu-id="412ac-175">After updating the previous `Startup.Configure` code:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseStaticFiles();

    app.UseRouting();

    app.UseCors();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapHub<ChatHub>("/chat");
        endpoints.MapControllerRoute("default", "{controller=Home}/{action=Index}/{id?}");
    });
}
```

### <a name="security-middleware-guidance"></a><span data-ttu-id="412ac-176">Guía de middleware de seguridad</span><span class="sxs-lookup"><span data-stu-id="412ac-176">Security middleware guidance</span></span>

<span data-ttu-id="412ac-177">La compatibilidad con la autorización y CORS está unificada en torno al enfoque de [middleware](xref:fundamentals/middleware/index) .</span><span class="sxs-lookup"><span data-stu-id="412ac-177">Support for authorization and CORS is unified around the [middleware](xref:fundamentals/middleware/index) approach.</span></span> <span data-ttu-id="412ac-178">Esto permite el uso del mismo middleware y la misma funcionalidad en estos escenarios.</span><span class="sxs-lookup"><span data-stu-id="412ac-178">This allows use of the same middleware and functionality across these scenarios.</span></span> <span data-ttu-id="412ac-179">En esta versión se proporciona un middleware de autorización actualizado, y el middleware CORS se ha mejorado para que pueda comprender los atributos usados por los controladores MVC.</span><span class="sxs-lookup"><span data-stu-id="412ac-179">An updated authorization middleware is provided in this release, and CORS Middleware is enhanced so that it can understand the attributes used by MVC controllers.</span></span>

#### <a name="cors"></a><span data-ttu-id="412ac-180">CORS</span><span class="sxs-lookup"><span data-stu-id="412ac-180">CORS</span></span>

<span data-ttu-id="412ac-181">Anteriormente, CORS podía ser difícil de configurar.</span><span class="sxs-lookup"><span data-stu-id="412ac-181">Previously, CORS could be difficult to configure.</span></span> <span data-ttu-id="412ac-182">El middleware se proporcionó para su uso en algunos casos de uso, pero los filtros de MVC debían usarse **sin** el middleware en otros casos de uso.</span><span class="sxs-lookup"><span data-stu-id="412ac-182">Middleware was provided for use in some use cases, but MVC filters were intended to be used **without** the middleware in other use cases.</span></span> <span data-ttu-id="412ac-183">Con ASP.NET Core 3,0, se recomienda que todas las aplicaciones que requieren CORS usen el middleware de CORS en tándem con el enrutamiento de puntos de conexión.</span><span class="sxs-lookup"><span data-stu-id="412ac-183">With ASP.NET Core 3.0, we recommend that all apps that require CORS use the CORS Middleware in tandem with Endpoint Routing.</span></span> <span data-ttu-id="412ac-184">`UseCors`se puede proporcionar con una directiva predeterminada, `[EnableCors]` y los atributos y `[DisableCors]` se pueden usar para invalidar la directiva predeterminada cuando sea necesario.</span><span class="sxs-lookup"><span data-stu-id="412ac-184">`UseCors` can be provided with a default policy, and `[EnableCors]` and `[DisableCors]` attributes can be used to override the default policy where required.</span></span> 

<span data-ttu-id="412ac-185">En el ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="412ac-185">In the following example:</span></span>

* <span data-ttu-id="412ac-186">CORS está habilitado para todos los puntos de `default` conexión con la Directiva con nombre.</span><span class="sxs-lookup"><span data-stu-id="412ac-186">CORS is enabled for all endpoints with the `default` named policy.</span></span>
* <span data-ttu-id="412ac-187">La `MyController` clase deshabilita CORS con el `[DisableCors]` atributo.</span><span class="sxs-lookup"><span data-stu-id="412ac-187">The `MyController` class disables CORS with the `[DisableCors]` attribute.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseCors("default"); 

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapDefaultControllerRoute();
    });
}

[DisableCors]
public class MyController : ControllerBase
{
    ...
}
```

#### <a name="authorization"></a><span data-ttu-id="412ac-188">Autorización</span><span class="sxs-lookup"><span data-stu-id="412ac-188">Authorization</span></span>

<span data-ttu-id="412ac-189">En versiones anteriores de ASP.net Core, se proporcionaba compatibilidad con la `[Authorize]` autorización mediante el atributo.</span><span class="sxs-lookup"><span data-stu-id="412ac-189">In earlier versions of ASP.NET Core, authorization support was provided via the `[Authorize]` attribute.</span></span> <span data-ttu-id="412ac-190">El middleware de autorización no estaba disponible.</span><span class="sxs-lookup"><span data-stu-id="412ac-190">Authorization middleware wasn't available.</span></span> <span data-ttu-id="412ac-191">En ASP.NET Core 3,0, se requiere middleware de autorización.</span><span class="sxs-lookup"><span data-stu-id="412ac-191">In ASP.NET Core 3.0, authorization middleware is required.</span></span> <span data-ttu-id="412ac-192">Se recomienda colocar el middleware de autorización de`UseAuthorization`ASP.net Core () `UseAuthentication`inmediatamente después de.</span><span class="sxs-lookup"><span data-stu-id="412ac-192">We recommend placing the ASP.NET Core Authorization Middleware (`UseAuthorization`) immediately after `UseAuthentication`.</span></span> <span data-ttu-id="412ac-193">El middleware de autorización también puede configurarse con una directiva predeterminada, que se puede invalidar.</span><span class="sxs-lookup"><span data-stu-id="412ac-193">The Authorization Middleware can also be configured with a default policy, which can be overridden.</span></span>

<span data-ttu-id="412ac-194">En ASP.net Core 3,0 o posterior, `UseAuthorization` se llama a `Startup.Configure`en, y lo `HomeController` siguiente requiere un usuario con sesión iniciada:</span><span class="sxs-lookup"><span data-stu-id="412ac-194">In ASP.NET Core 3.0 or later, `UseAuthorization` is called in `Startup.Configure`, and the following `HomeController` requires a signed in user:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapDefaultControllerRoute();
    });
}

public class HomeController : ControllerBase
{
    [Authorize]
    public IActionResult BuyWidgets()
    {
        ...
    }
}
```

<span data-ttu-id="412ac-195">Si la aplicación usa `AuthorizeFilter` como filtro global en MVC, se recomienda refactorizar el código para proporcionar una directiva en la llamada a. `AddAuthorization`</span><span class="sxs-lookup"><span data-stu-id="412ac-195">If the app uses an `AuthorizeFilter` as a global filter in MVC, we recommend refactoring the code to provide a policy in the call to `AddAuthorization`.</span></span>

<span data-ttu-id="412ac-196">`DefaultPolicy` Se configura inicialmente para requerir autenticación, por lo que no se requiere ninguna configuración adicional.</span><span class="sxs-lookup"><span data-stu-id="412ac-196">The `DefaultPolicy` is initially configured to require authentication, so no additional configuration is required.</span></span> <span data-ttu-id="412ac-197">En el ejemplo siguiente, los puntos de conexión de MVC `RequireAuthorization` se marcan como para que todas las solicitudes se `DefaultPolicy`deben autorizar en función de.</span><span class="sxs-lookup"><span data-stu-id="412ac-197">In the following example, MVC endpoints are marked as `RequireAuthorization` so that all requests must be authorized based on the `DefaultPolicy`.</span></span> <span data-ttu-id="412ac-198">Sin embargo, `HomeController` permite el acceso sin que el usuario inicie sesión en la `[AllowAnonymous]`aplicación debido a:</span><span class="sxs-lookup"><span data-stu-id="412ac-198">However, the `HomeController` allows access without the user signing into the app due to `[AllowAnonymous]`:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapDefaultControllerRoute().RequireAuthorization();
    });
}

[AllowAnonymous]
public class HomeController : ControllerBase
{
    ...
}
```

<span data-ttu-id="412ac-199">También se pueden personalizar las directivas.</span><span class="sxs-lookup"><span data-stu-id="412ac-199">Policies can also be customized.</span></span> <span data-ttu-id="412ac-200">Basándose en el ejemplo anterior, `DefaultPolicy` se configura para requerir autenticación y un ámbito específico:</span><span class="sxs-lookup"><span data-stu-id="412ac-200">Building upon the previous example, the `DefaultPolicy` is configured to require authentication and a specific scope:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    ...
    
    services.AddAuthorization(options =>
    {
        options.DefaultPolicy = new AuthorizationPolicyBuilder()
          .RequireAuthenticatedUser()
          .RequireScope("MyScope")
          .Build();
    });
}

public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapDefaultControllerRoute().RequireAuthorization();
    });
}

[AllowAnonymous]
public class HomeController : ControllerBase
{
    ...
}
```

<span data-ttu-id="412ac-201">Como alternativa, se pueden configurar todos los puntos de conexión para requerir `[Authorize]` la `RequireAuthorization` autorización sin o `FallbackPolicy`mediante la configuración de.</span><span class="sxs-lookup"><span data-stu-id="412ac-201">Alternatively, all endpoints can be configured to require authorization without `[Authorize]` or `RequireAuthorization` by configuring a `FallbackPolicy`.</span></span> <span data-ttu-id="412ac-202">`FallbackPolicy` Es diferente `DefaultPolicy`de.</span><span class="sxs-lookup"><span data-stu-id="412ac-202">The `FallbackPolicy` is different from the `DefaultPolicy`.</span></span> <span data-ttu-id="412ac-203">Se desencadena con `[Authorize]` `FallbackPolicy` o `RequireAuthorization`, mientras que se desencadena cuando no se establece ninguna otra directiva. `DefaultPolicy`</span><span class="sxs-lookup"><span data-stu-id="412ac-203">The `DefaultPolicy` is triggered by `[Authorize]` or `RequireAuthorization`, while the `FallbackPolicy` is triggered when no other policy is set.</span></span> <span data-ttu-id="412ac-204">`FallbackPolicy`está configurado inicialmente para permitir solicitudes sin autorización.</span><span class="sxs-lookup"><span data-stu-id="412ac-204">`FallbackPolicy` is initially configured to allow requests without authorization.</span></span>

<span data-ttu-id="412ac-205">El ejemplo siguiente es el mismo que el anterior `DefaultPolicy` , pero `FallbackPolicy` usa para requerir siempre la autenticación en todos los extremos excepto cuando `[AllowAnonymous]` se especifica:</span><span class="sxs-lookup"><span data-stu-id="412ac-205">The following example is the same as the preceding `DefaultPolicy` example but uses the `FallbackPolicy` to always require authentication on all endpoints except when `[AllowAnonymous]` is specified:</span></span>

```csharp
public void ConfigureServices(IServiceCollection services)
{
    ...
    services.AddAuthorization(options =>
    {
        options.FallbackPolicy = new AuthorizationPolicyBuilder()
          .RequireAuthenticatedUser()
          .RequireScope("MyScope")
          .Build();
    });
}

public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapDefaultControllerRoute();
    });
}

[AllowAnonymous]
public class HomeController : ControllerBase
{
    ...
}
```

<span data-ttu-id="412ac-206">La autorización por middleware funciona sin el marco de trabajo que tiene un conocimiento específico de la autorización.</span><span class="sxs-lookup"><span data-stu-id="412ac-206">Authorization by middleware works without the framework having any specific knowledge of authorization.</span></span> <span data-ttu-id="412ac-207">Por ejemplo, las [comprobaciones de estado](xref:host-and-deploy/health-checks) no tienen ningún conocimiento específico de la autorización, pero las comprobaciones de estado pueden tener una directiva de autorización configurable aplicada por el middleware.</span><span class="sxs-lookup"><span data-stu-id="412ac-207">For instance, [health checks](xref:host-and-deploy/health-checks) has no specific knowledge of authorization, but health checks can have a configurable authorization policy applied by the middleware.</span></span>

<span data-ttu-id="412ac-208">Además, cada punto de conexión puede personalizar sus requisitos de autorización.</span><span class="sxs-lookup"><span data-stu-id="412ac-208">Additionally, each endpoint can customize its authorization requirements.</span></span> <span data-ttu-id="412ac-209">En el ejemplo siguiente, `UseAuthorization` procesa la `DefaultPolicy`autorización con, pero el `/healthz` extremo de comprobación de estado `admin` requiere un usuario:</span><span class="sxs-lookup"><span data-stu-id="412ac-209">In the following example, `UseAuthorization` processes authorization with the `DefaultPolicy`, but the `/healthz` health check endpoint requires an `admin` user:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseAuthentication();
    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints
            .MapHealthChecks("/healthz")
            .RequireAuthorization(new AuthorizeAttribute(){ Roles = "admin", });
    });
}
```

<span data-ttu-id="412ac-210">La protección se implementa en algunos escenarios.</span><span class="sxs-lookup"><span data-stu-id="412ac-210">Protection is implemented for some scenarios.</span></span> <span data-ttu-id="412ac-211">`UseEndpoint`el middleware produce una excepción si se omite una directiva de autorización o CORS debido a que falta un middleware.</span><span class="sxs-lookup"><span data-stu-id="412ac-211">`UseEndpoint` middleware throws an exception if an authorization or CORS policy is skipped due to missing middleware.</span></span> <span data-ttu-id="412ac-212">La compatibilidad con el analizador para proporcionar información adicional sobre la configuración inestable está en curso.</span><span class="sxs-lookup"><span data-stu-id="412ac-212">Analyzer support to provide additional feedback about misconfiguration is in progress.</span></span>

### <a name="migrate-signalr"></a><span data-ttu-id="412ac-213">Migración de Signalr</span><span class="sxs-lookup"><span data-stu-id="412ac-213">Migrate SignalR</span></span>

<span data-ttu-id="412ac-214">La asignación de los concentradores de Signalr `UseEndpoints`ahora tiene lugar dentro de.</span><span class="sxs-lookup"><span data-stu-id="412ac-214">Mapping of SignalR hubs now takes place inside `UseEndpoints`.</span></span> 

<span data-ttu-id="412ac-215">Asigne cada concentrador `MapHub`con.</span><span class="sxs-lookup"><span data-stu-id="412ac-215">Map each hub with `MapHub`.</span></span> <span data-ttu-id="412ac-216">Como en versiones anteriores, cada concentrador aparece explícitamente en la lista.</span><span class="sxs-lookup"><span data-stu-id="412ac-216">As in previous versions, each hub is explicitly listed.</span></span>

<span data-ttu-id="412ac-217">En el ejemplo siguiente, se agrega compatibilidad `ChatHub` con la central signalr:</span><span class="sxs-lookup"><span data-stu-id="412ac-217">In the following example, support for the `ChatHub` SignalR hub is added:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapHub<ChatHub>();
    });
}
```

<span data-ttu-id="412ac-218">Existe una nueva opción para controlar los límites de tamaño de los mensajes de los clientes.</span><span class="sxs-lookup"><span data-stu-id="412ac-218">There is a new option for controlling message size limits from clients.</span></span> <span data-ttu-id="412ac-219">Por ejemplo, en `Startup.ConfigureServices`:</span><span class="sxs-lookup"><span data-stu-id="412ac-219">For example, in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddSignalR(hubOptions =>
{
    hubOptions.MaximumReceiveMessageSize = 32768;
});
```

<span data-ttu-id="412ac-220">En ASP.net Core 2,2, puede establecer el y `TransportMaxBufferSize` el que controlarían de forma eficaz el tamaño máximo de los mensajes.</span><span class="sxs-lookup"><span data-stu-id="412ac-220">In ASP.NET Core 2.2, you could set the `TransportMaxBufferSize` and that would effectively control the maximum message size.</span></span> <span data-ttu-id="412ac-221">En ASP.NET Core 3,0, esa opción ahora solo controla el tamaño máximo antes de que se observe la presión.</span><span class="sxs-lookup"><span data-stu-id="412ac-221">In ASP.NET Core 3.0, that option now only controls the maximum size before backpressure is observed.</span></span>

### <a name="migrate-mvc-controllers"></a><span data-ttu-id="412ac-222">Migrar controladores de MVC</span><span class="sxs-lookup"><span data-stu-id="412ac-222">Migrate MVC controllers</span></span>

<span data-ttu-id="412ac-223">La asignación de controladores ahora tiene lugar `UseEndpoints`dentro de.</span><span class="sxs-lookup"><span data-stu-id="412ac-223">Mapping of controllers now takes place inside `UseEndpoints`.</span></span> 

<span data-ttu-id="412ac-224">Agregue `MapControllers` si la aplicación usa el enrutamiento de atributos.</span><span class="sxs-lookup"><span data-stu-id="412ac-224">Add `MapControllers` if the app uses attribute routing.</span></span> <span data-ttu-id="412ac-225">Dado que el enrutamiento incluye compatibilidad con muchos marcos en ASP.NET Core 3,0 o posterior, la adición de controladores de enrutamiento de atributos es participación.</span><span class="sxs-lookup"><span data-stu-id="412ac-225">Since routing includes support for many frameworks in ASP.NET Core 3.0 or later, adding attribute-routed controllers is opt-in.</span></span> 

<span data-ttu-id="412ac-226">Reemplace lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="412ac-226">Replace the following:</span></span>

* <span data-ttu-id="412ac-227">`MapRoute`Gracias`MapControllerRoute`</span><span class="sxs-lookup"><span data-stu-id="412ac-227">`MapRoute` with `MapControllerRoute`</span></span>
* <span data-ttu-id="412ac-228">`MapAreaRoute`Gracias`MapAreaControllerRoute`</span><span class="sxs-lookup"><span data-stu-id="412ac-228">`MapAreaRoute` with `MapAreaControllerRoute`</span></span>

<span data-ttu-id="412ac-229">Puesto que el enrutamiento ahora incluye compatibilidad con algo más que MVC, la terminología ha cambiado para que estos métodos indiquen claramente lo que hacen.</span><span class="sxs-lookup"><span data-stu-id="412ac-229">Since routing now includes support for more than just MVC, the terminology has changed to make these methods clearly state what they do.</span></span> <span data-ttu-id="412ac-230">Las rutas convencionales como `MapControllerRoute` / `MapAreaControllerRoute` se aplicanenelordenenqueseagregan./ `MapDefaultControllerRoute`</span><span class="sxs-lookup"><span data-stu-id="412ac-230">Conventional routes such as `MapControllerRoute`/`MapAreaControllerRoute`/`MapDefaultControllerRoute` are applied in the order that they're added.</span></span> <span data-ttu-id="412ac-231">Coloque primero rutas más específicas (por ejemplo, las rutas de un área).</span><span class="sxs-lookup"><span data-stu-id="412ac-231">Place more specific routes (such as routes for an area) first.</span></span>

<span data-ttu-id="412ac-232">En el ejemplo siguiente:</span><span class="sxs-lookup"><span data-stu-id="412ac-232">In the following example:</span></span>

* <span data-ttu-id="412ac-233">`MapControllers`agrega compatibilidad con los controladores de enrutamiento de atributos.</span><span class="sxs-lookup"><span data-stu-id="412ac-233">`MapControllers` adds support for attribute-routed controllers.</span></span>
* <span data-ttu-id="412ac-234">`MapAreaControllerRoute`agrega una ruta convencional para los controladores de un área.</span><span class="sxs-lookup"><span data-stu-id="412ac-234">`MapAreaControllerRoute` adds a conventional route for controllers in an area.</span></span>
* <span data-ttu-id="412ac-235">`MapControllerRoute`agrega una ruta convencional para los controladores.</span><span class="sxs-lookup"><span data-stu-id="412ac-235">`MapControllerRoute` adds a conventional route for controllers.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllers();
        endpoints.MapAreaControllerRoute(
            "admin", 
            "admin", 
            "Admin/{controller=Home}/{action=Index}/{id?}");
        endpoints.MapControllerRoute(
            "default", "{controller=Home}/{action=Index}/{id?}");
    });
}
```

### <a name="migrate-razor-pages"></a><span data-ttu-id="412ac-236">Migrar Razor Pages</span><span class="sxs-lookup"><span data-stu-id="412ac-236">Migrate Razor Pages</span></span>

<span data-ttu-id="412ac-237">La asignación Razor Pages ahora tiene lugar `UseEndpoints`dentro de.</span><span class="sxs-lookup"><span data-stu-id="412ac-237">Mapping Razor Pages now takes place inside `UseEndpoints`.</span></span>

<span data-ttu-id="412ac-238">Agregue `MapRazorPages` si la aplicación usa Razor pages.</span><span class="sxs-lookup"><span data-stu-id="412ac-238">Add `MapRazorPages` if the app uses Razor Pages.</span></span> <span data-ttu-id="412ac-239">Dado que el enrutamiento del punto de conexión incluye compatibilidad con muchos marcos, agregar Razor Pages es ahora opcional.</span><span class="sxs-lookup"><span data-stu-id="412ac-239">Since Endpoint Routing includes support for many frameworks, adding Razor Pages is now opt-in.</span></span>

<span data-ttu-id="412ac-240">En el ejemplo siguiente, `MapRazorPages` agrega compatibilidad con Razor pages:</span><span class="sxs-lookup"><span data-stu-id="412ac-240">In the following example, `MapRazorPages` adds support for Razor Pages:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapRazorPages();
    });
}
```

### <a name="use-mvc-without-endpoint-routing"></a><span data-ttu-id="412ac-241">Uso de MVC sin enrutamiento de punto de conexión</span><span class="sxs-lookup"><span data-stu-id="412ac-241">Use MVC without Endpoint Routing</span></span>

<span data-ttu-id="412ac-242">El uso de `UseMvc` MVC `UseMvcWithDefaultRoute` a través de o en ASP.net Core 3,0 requiere una participación `Startup.ConfigureServices`explícita dentro de.</span><span class="sxs-lookup"><span data-stu-id="412ac-242">Using MVC via `UseMvc` or `UseMvcWithDefaultRoute` in ASP.NET Core 3.0 requires an explicit opt-in inside `Startup.ConfigureServices`.</span></span> <span data-ttu-id="412ac-243">Esto es necesario porque MVC debe saber si puede confiar en la autorización y el middleware CORS durante la inicialización.</span><span class="sxs-lookup"><span data-stu-id="412ac-243">This is required because MVC must know whether it can rely on the authorization and CORS Middleware during initialization.</span></span> <span data-ttu-id="412ac-244">Se proporciona un analizador que advierte si la aplicación intenta usar una configuración no admitida.</span><span class="sxs-lookup"><span data-stu-id="412ac-244">An analyzer is provided that warns if the app attempts to use an unsupported configuration.</span></span>

<span data-ttu-id="412ac-245">Si la aplicación requiere compatibilidad `IRouter` heredada, `EnableEndpointRouting` deshabilite el uso de cualquiera de `Startup.ConfigureServices`los métodos siguientes en:</span><span class="sxs-lookup"><span data-stu-id="412ac-245">If the app requires legacy `IRouter` support, disable `EnableEndpointRouting` using any of the following approaches in `Startup.ConfigureServices`:</span></span>

```csharp
services.AddMvc(options => options.EnableEndpointRouting = false);
```

```csharp
services.AddControllers(options => options.EnableEndpointRouting = false);
```

```csharp
services.AddControllersWithViews(options => options.EnableEndpointRouting = false);

```

```csharp
services.AddRazorPages().AddMvcOptions(options => options.EnableEndpointRouting = false);
```

### <a name="migrate-health-checks"></a><span data-ttu-id="412ac-246">Migrar comprobaciones de estado</span><span class="sxs-lookup"><span data-stu-id="412ac-246">Migrate health checks</span></span>

<span data-ttu-id="412ac-247">Las comprobaciones de estado se pueden usar como un *enrutador* con enrutamiento de punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="412ac-247">Health checks can be used as a *router-ware* with Endpoint Routing.</span></span>

<span data-ttu-id="412ac-248">Agregue `MapHealthChecks` para usar comprobaciones de estado con enrutamiento de punto de conexión.</span><span class="sxs-lookup"><span data-stu-id="412ac-248">Add `MapHealthChecks` to use health checks with Endpoint Routing.</span></span> <span data-ttu-id="412ac-249">El `MapHealthChecks` método acepta argumentos similares a `UseHealthChecks`.</span><span class="sxs-lookup"><span data-stu-id="412ac-249">The `MapHealthChecks` method accepts arguments similar to `UseHealthChecks`.</span></span> <span data-ttu-id="412ac-250">La ventaja de usar `MapHealthChecks` over `UseHealthChecks` es la capacidad de aplicar la autorización y tener un control más preciso sobre la Directiva de coincidencia.</span><span class="sxs-lookup"><span data-stu-id="412ac-250">The advantage of using `MapHealthChecks` over `UseHealthChecks` is the ability to apply authorization and to have greater fine-grained control over the matching policy.</span></span> 

<span data-ttu-id="412ac-251">En el ejemplo siguiente, `MapHealthChecks` se llama a para un extremo de comprobación `/healthz`de estado en:</span><span class="sxs-lookup"><span data-stu-id="412ac-251">In the following example, `MapHealthChecks` is called for a health check endpoint at `/healthz`:</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    ...

    app.UseRouting();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapHealthChecks("/healthz", new HealthCheckOptions() { });
    });
}
```

## <a name="hostbuilder-replaces-webhostbuilder"></a><span data-ttu-id="412ac-252">HostBuilder reemplaza a WebHostBuilder</span><span class="sxs-lookup"><span data-stu-id="412ac-252">HostBuilder replaces WebHostBuilder</span></span>

<span data-ttu-id="412ac-253">Las plantillas ASP.NET Core 3,0 usan el [host genérico](xref:fundamentals/host/generic-host).</span><span class="sxs-lookup"><span data-stu-id="412ac-253">The ASP.NET Core 3.0 templates use [Generic Host](xref:fundamentals/host/generic-host).</span></span> <span data-ttu-id="412ac-254">Las versiones anteriores usaban el [host web](xref:fundamentals/host/web-host).</span><span class="sxs-lookup"><span data-stu-id="412ac-254">Previous versions used [Web Host](xref:fundamentals/host/web-host).</span></span> <span data-ttu-id="412ac-255">En el código siguiente se muestra la clase generada `Program` de la plantilla ASP.net Core 3,0:</span><span class="sxs-lookup"><span data-stu-id="412ac-255">The following code shows the ASP.NET Core 3.0 template generated `Program` class:</span></span>

[!code-csharp[](22-to-30/samples/Program.cs?name=snippet)]

<span data-ttu-id="412ac-256">En el código siguiente se muestra la clase generada `Program` por la plantilla ASP.net Core 2,2:</span><span class="sxs-lookup"><span data-stu-id="412ac-256">The following code shows the ASP.NET Core 2.2 template-generated `Program` class:</span></span>

[!code-csharp[](22-to-30/samples/Program2.2.cs?name=snippet)]

<span data-ttu-id="412ac-257"><xref:Microsoft.AspNetCore.Hosting.IWebHostBuilder>permanece en 3,0 y es el tipo del que `webBuilder` se ha detectado en el ejemplo de código anterior.</span><span class="sxs-lookup"><span data-stu-id="412ac-257"><xref:Microsoft.AspNetCore.Hosting.IWebHostBuilder> remains in 3.0 and is the type of the `webBuilder` seen in the preceding code sample.</span></span> <span data-ttu-id="412ac-258"><xref:Microsoft.AspNetCore.Hosting.WebHostBuilder>quedará en desuso en una versión futura y se reemplazará por `HostBuilder`.</span><span class="sxs-lookup"><span data-stu-id="412ac-258"><xref:Microsoft.AspNetCore.Hosting.WebHostBuilder> will be deprecated in a future release and replaced by `HostBuilder`.</span></span>

<span data-ttu-id="412ac-259">El cambio más significativo de `WebHostBuilder` a `HostBuilder` es en la [inserción de dependencias (di)](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="412ac-259">The most significant change from `WebHostBuilder` to `HostBuilder` is in [dependency injection (DI)](xref:fundamentals/dependency-injection).</span></span> <span data-ttu-id="412ac-260">Cuando se `HostBuilder`usa, solo se puede <xref:Microsoft.Extensions.Configuration.IConfiguration> insertar <xref:Microsoft.AspNetCore.Hosting.IHostingEnvironment> y `Startup`en el constructor de.</span><span class="sxs-lookup"><span data-stu-id="412ac-260">When using `HostBuilder`, you can only inject <xref:Microsoft.Extensions.Configuration.IConfiguration> and <xref:Microsoft.AspNetCore.Hosting.IHostingEnvironment> into `Startup`'s constructor.</span></span> <span data-ttu-id="412ac-261">Las `HostBuilder` restricciones de di:</span><span class="sxs-lookup"><span data-stu-id="412ac-261">The `HostBuilder` DI constraints:</span></span>

* <span data-ttu-id="412ac-262">Habilite el contenedor de DI para que se compile solo una vez.</span><span class="sxs-lookup"><span data-stu-id="412ac-262">Enable the DI container to be built only one time.</span></span>
* <span data-ttu-id="412ac-263">Evita los problemas de duración de los objetos resultantes como resolver varias instancias de singleton.</span><span class="sxs-lookup"><span data-stu-id="412ac-263">Avoids the resulting object lifetime issues like resolving multiple instances of singletons.</span></span>

## <a name="update-signalr-code"></a><span data-ttu-id="412ac-264">Actualizar código de Signalr</span><span class="sxs-lookup"><span data-stu-id="412ac-264">Update SignalR code</span></span>

<span data-ttu-id="412ac-265">`System.Text.Json`es ahora el protocolo de concentrador predeterminado utilizado por el cliente y el servidor.</span><span class="sxs-lookup"><span data-stu-id="412ac-265">`System.Text.Json` is now the default Hub Protocol used by both the client and server.</span></span>

<span data-ttu-id="412ac-266">En `Startup.ConfigureServices`, llame `AddJsonProtocol` a para establecer las opciones del serializador.</span><span class="sxs-lookup"><span data-stu-id="412ac-266">In `Startup.ConfigureServices`, call `AddJsonProtocol` to set serializer options.</span></span>

<span data-ttu-id="412ac-267">**Servidor**</span><span class="sxs-lookup"><span data-stu-id="412ac-267">**Server:**</span></span>

```csharp
services.AddSignalR(...)
        .AddJsonProtocol(options =>
        {
            options.WriteIndented = false;
        })
```

<span data-ttu-id="412ac-268">**Nº**</span><span class="sxs-lookup"><span data-stu-id="412ac-268">**Client:**</span></span>

```csharp
new HubConnectionBuilder()
    .WithUrl("/chatHub")
    .AddJsonProtocol(options =>
    {
        options.WriteIndented = false;
    })
    .Build();
```

### <a name="switch-to-newtonsoftjson"></a><span data-ttu-id="412ac-269">Cambiar a Newtonsoft. JSON</span><span class="sxs-lookup"><span data-stu-id="412ac-269">Switch to Newtonsoft.Json</span></span>

<span data-ttu-id="412ac-270">Si utiliza características de `Newtonsoft.Json` que no se admiten en `System.Text.Json`, puede volver a: `Newtonsoft.Json`</span><span class="sxs-lookup"><span data-stu-id="412ac-270">If you're using features of `Newtonsoft.Json` that aren't supported in `System.Text.Json`, you can switch back to `Newtonsoft.Json`:</span></span>

1. <span data-ttu-id="412ac-271">Instale el paquete NuGet [Microsoft. AspNetCore. signalr. Protocols. NewtonsoftJson](https://www.nuget.org/packages/Microsoft.AspNetCore.SignalR.Protocols.NewtonsoftJson) .</span><span class="sxs-lookup"><span data-stu-id="412ac-271">Install the [Microsoft.AspNetCore.SignalR.Protocols.NewtonsoftJson](https://www.nuget.org/packages/Microsoft.AspNetCore.SignalR.Protocols.NewtonsoftJson) NuGet package.</span></span>
1. <span data-ttu-id="412ac-272">En el cliente, encadenar una `AddNewtonsoftJsonProtocol` llamada de método a la `HubConnectionBuilder` instancia:</span><span class="sxs-lookup"><span data-stu-id="412ac-272">On the client, chain an `AddNewtonsoftJsonProtocol` method call to the `HubConnectionBuilder` instance:</span></span>

    ```csharp
    new HubConnectionBuilder()
        .WithUrl("/chatHub")
        .AddNewtonsoftJsonProtocol(...)
        .Build();
    ```

1. <span data-ttu-id="412ac-273">En el servidor, encadenar una `AddNewtonsoftJsonProtocol` llamada de método a la `Startup.ConfigureServices` `AddSignalR` llamada al método en:</span><span class="sxs-lookup"><span data-stu-id="412ac-273">On the server, chain an `AddNewtonsoftJsonProtocol` method call to the `AddSignalR` method call in `Startup.ConfigureServices`:</span></span>

    ```csharp
    services.AddSignalR()
        .AddNewtonsoftJsonProtocol(...);
    ```

## <a name="opt-in-to-runtime-compilation"></a><span data-ttu-id="412ac-274">Participar en la compilación en tiempo de ejecución</span><span class="sxs-lookup"><span data-stu-id="412ac-274">Opt in to runtime compilation</span></span>

<span data-ttu-id="412ac-275">En 3,0, la compilación en tiempo de ejecución es un escenario de participación.</span><span class="sxs-lookup"><span data-stu-id="412ac-275">In 3.0, runtime compilation is an opt-in scenario.</span></span> <span data-ttu-id="412ac-276">Para habilitar la compilación en tiempo https://docs.microsoft.com/aspnet/core/mvc/views/view-compilation?view=aspnetcore-3.0#runtime-compilation de ejecución, vea.</span><span class="sxs-lookup"><span data-stu-id="412ac-276">To enable runtime compilation, see https://docs.microsoft.com/aspnet/core/mvc/views/view-compilation?view=aspnetcore-3.0#runtime-compilation.</span></span>
