---
title: Migrar desde ClaimsPrincipal. Current
author: mjrousos
description: Obtenga información sobre cómo migrar de ClaimsPrincipal. Current para recuperar la identidad del usuario autenticado actual y las notificaciones en ASP.NET Core.
ms.author: scaddie
ms.custom: mvc
ms.date: 03/26/2019
uid: migration/claimsprincipal-current
ms.openlocfilehash: f7472f5b851d3869da3d26b881e276ce4ca004fb
ms.sourcegitcommit: 231780c8d7848943e5e9fd55e93f437f7e5a371d
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 11/15/2019
ms.locfileid: "74115974"
---
# <a name="migrate-from-claimsprincipalcurrent"></a><span data-ttu-id="7d903-103">Migrar desde ClaimsPrincipal. Current</span><span class="sxs-lookup"><span data-stu-id="7d903-103">Migrate from ClaimsPrincipal.Current</span></span>

<span data-ttu-id="7d903-104">En los proyectos de ASP.NET 4. x, era habitual usar [ClaimsPrincipal. Current](/dotnet/api/system.security.claims.claimsprincipal.current) para recuperar la identidad y las notificaciones del usuario autenticado actual.</span><span class="sxs-lookup"><span data-stu-id="7d903-104">In ASP.NET 4.x projects, it was common to use [ClaimsPrincipal.Current](/dotnet/api/system.security.claims.claimsprincipal.current) to retrieve the current authenticated user's identity and claims.</span></span> <span data-ttu-id="7d903-105">En ASP.NET Core, esta propiedad ya no se establece.</span><span class="sxs-lookup"><span data-stu-id="7d903-105">In ASP.NET Core, this property is no longer set.</span></span> <span data-ttu-id="7d903-106">El código que depende de él debe actualizarse para obtener la identidad del usuario autenticado actual a través de un medio diferente.</span><span class="sxs-lookup"><span data-stu-id="7d903-106">Code that was depending on it needs to be updated to get the current authenticated user's identity through a different means.</span></span>

## <a name="context-specific-data-instead-of-static-data"></a><span data-ttu-id="7d903-107">Datos específicos del contexto en lugar de datos estáticos</span><span class="sxs-lookup"><span data-stu-id="7d903-107">Context-specific data instead of static data</span></span>

<span data-ttu-id="7d903-108">Cuando se usa ASP.NET Core, no se establecen los valores de `ClaimsPrincipal.Current` y `Thread.CurrentPrincipal`.</span><span class="sxs-lookup"><span data-stu-id="7d903-108">When using ASP.NET Core, the values of both `ClaimsPrincipal.Current` and `Thread.CurrentPrincipal` aren't set.</span></span> <span data-ttu-id="7d903-109">Estas propiedades representan el estado estático, que normalmente evita ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="7d903-109">These properties both represent static state, which ASP.NET Core generally avoids.</span></span> <span data-ttu-id="7d903-110">En su lugar, la arquitectura de ASP.NET Core es recuperar las dependencias (por ejemplo, la identidad del usuario actual) de las colecciones de servicios específicas del contexto (mediante el modelo de [inserción de dependencias](xref:fundamentals/dependency-injection) ).</span><span class="sxs-lookup"><span data-stu-id="7d903-110">Instead, ASP.NET Core's architecture is to retrieve dependencies (like the current user's identity) from context-specific service collections (using its [dependency injection](xref:fundamentals/dependency-injection) (DI) model).</span></span> <span data-ttu-id="7d903-111">Además, `Thread.CurrentPrincipal` es un subproceso estático, por lo que puede que no conserve los cambios en algunos escenarios asincrónicos (y `ClaimsPrincipal.Current` simplemente llama a `Thread.CurrentPrincipal` de forma predeterminada).</span><span class="sxs-lookup"><span data-stu-id="7d903-111">What's more, `Thread.CurrentPrincipal` is thread static, so it may not persist changes in some asynchronous scenarios (and `ClaimsPrincipal.Current` just calls `Thread.CurrentPrincipal` by default).</span></span>

<span data-ttu-id="7d903-112">Para comprender los tipos de problemas que los miembros estáticos de subproceso pueden provocar en escenarios asincrónicos, considere el siguiente fragmento de código:</span><span class="sxs-lookup"><span data-stu-id="7d903-112">To understand the sorts of problems thread static members can lead to in asynchronous scenarios, consider the following code snippet:</span></span>

```csharp
// Create a ClaimsPrincipal and set Thread.CurrentPrincipal
var identity = new ClaimsIdentity();
identity.AddClaim(new Claim(ClaimTypes.Name, "User1"));
Thread.CurrentPrincipal = new ClaimsPrincipal(identity);

// Check the current user
Console.WriteLine($"Current user: {Thread.CurrentPrincipal?.Identity.Name}");

// For the method to complete asynchronously
await Task.Yield();

// Check the current user after
Console.WriteLine($"Current user: {Thread.CurrentPrincipal?.Identity.Name}");
```

<span data-ttu-id="7d903-113">En el código de ejemplo anterior se establece `Thread.CurrentPrincipal` y se comprueba su valor antes y después de esperar una llamada asincrónica.</span><span class="sxs-lookup"><span data-stu-id="7d903-113">The preceding sample code sets `Thread.CurrentPrincipal` and checks its value before and after awaiting an asynchronous call.</span></span> <span data-ttu-id="7d903-114">`Thread.CurrentPrincipal` es específico del *subproceso* en el que se establece y es probable que el método reanude la ejecución en un subproceso diferente después de la espera.</span><span class="sxs-lookup"><span data-stu-id="7d903-114">`Thread.CurrentPrincipal` is specific to the *thread* on which it's set, and the method is likely to resume execution on a different thread after the await.</span></span> <span data-ttu-id="7d903-115">Por consiguiente, `Thread.CurrentPrincipal` está presente cuando se activa por primera vez pero es NULL después de la llamada a `await Task.Yield()`.</span><span class="sxs-lookup"><span data-stu-id="7d903-115">Consequently, `Thread.CurrentPrincipal` is present when it's first checked but is null after the call to `await Task.Yield()`.</span></span>

<span data-ttu-id="7d903-116">Obtener la identidad del usuario actual de la colección de servicios de DI de la aplicación también es más fácil de probar, ya que las identidades de prueba se pueden insertar fácilmente.</span><span class="sxs-lookup"><span data-stu-id="7d903-116">Getting the current user's identity from the app's DI service collection is more testable, too, since test identities can be easily injected.</span></span>

## <a name="retrieve-the-current-user-in-an-aspnet-core-app"></a><span data-ttu-id="7d903-117">Recuperar el usuario actual en una aplicación ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="7d903-117">Retrieve the current user in an ASP.NET Core app</span></span>

<span data-ttu-id="7d903-118">Hay varias opciones para recuperar el `ClaimsPrincipal` del usuario autenticado actual en ASP.NET Core en lugar de `ClaimsPrincipal.Current`:</span><span class="sxs-lookup"><span data-stu-id="7d903-118">There are several options for retrieving the current authenticated user's `ClaimsPrincipal` in ASP.NET Core in place of `ClaimsPrincipal.Current`:</span></span>

* <span data-ttu-id="7d903-119">**ControllerBase. usuario**.</span><span class="sxs-lookup"><span data-stu-id="7d903-119">**ControllerBase.User**.</span></span> <span data-ttu-id="7d903-120">Los controladores MVC pueden tener acceso al usuario autenticado actual con su propiedad [User](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.user) .</span><span class="sxs-lookup"><span data-stu-id="7d903-120">MVC controllers can access the current authenticated user with their [User](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.user) property.</span></span>
* <span data-ttu-id="7d903-121">**HttpContext. User**.</span><span class="sxs-lookup"><span data-stu-id="7d903-121">**HttpContext.User**.</span></span> <span data-ttu-id="7d903-122">Los componentes con acceso al `HttpContext` actual (por ejemplo, middleware) pueden obtener los `ClaimsPrincipal` del usuario actual de [HttpContext. User](/dotnet/api/microsoft.aspnetcore.http.httpcontext.user).</span><span class="sxs-lookup"><span data-stu-id="7d903-122">Components with access to the current `HttpContext` (middleware, for example) can get the current user's `ClaimsPrincipal` from [HttpContext.User](/dotnet/api/microsoft.aspnetcore.http.httpcontext.user).</span></span>
* <span data-ttu-id="7d903-123">**Pasado del llamador**.</span><span class="sxs-lookup"><span data-stu-id="7d903-123">**Passed in from caller**.</span></span> <span data-ttu-id="7d903-124">A menudo se llama a las bibliotecas sin acceso a la `HttpContext` actual desde los controladores o componentes de middleware, y puede hacer que la identidad del usuario actual se pase como argumento.</span><span class="sxs-lookup"><span data-stu-id="7d903-124">Libraries without access to the current `HttpContext` are often called from controllers or middleware components and can have the current user's identity passed as an argument.</span></span>
* <span data-ttu-id="7d903-125">**IHttpContextAccessor**.</span><span class="sxs-lookup"><span data-stu-id="7d903-125">**IHttpContextAccessor**.</span></span> <span data-ttu-id="7d903-126">El proyecto que se va a migrar a ASP.NET Core puede ser demasiado grande para pasar fácilmente la identidad del usuario actual a todas las ubicaciones necesarias.</span><span class="sxs-lookup"><span data-stu-id="7d903-126">The project being migrated to ASP.NET Core may be too large to easily pass the current user's identity to all necessary locations.</span></span> <span data-ttu-id="7d903-127">En tales casos, [IHttpContextAccessor](/dotnet/api/microsoft.aspnetcore.http.ihttpcontextaccessor) se puede usar como solución alternativa.</span><span class="sxs-lookup"><span data-stu-id="7d903-127">In such cases, [IHttpContextAccessor](/dotnet/api/microsoft.aspnetcore.http.ihttpcontextaccessor) can be used as a workaround.</span></span> <span data-ttu-id="7d903-128">`IHttpContextAccessor` puede tener acceso al `HttpContext` actual (si existe).</span><span class="sxs-lookup"><span data-stu-id="7d903-128">`IHttpContextAccessor` is able to access the current `HttpContext` (if one exists).</span></span> <span data-ttu-id="7d903-129">Si se usa DI, vea <xref:fundamentals/httpcontext>.</span><span class="sxs-lookup"><span data-stu-id="7d903-129">If DI is being used, see <xref:fundamentals/httpcontext>.</span></span> <span data-ttu-id="7d903-130">Una solución a corto plazo para obtener la identidad del usuario actual en el código que todavía no se ha actualizado para funcionar con la arquitectura basada en DI de ASP.NET Core sería:</span><span class="sxs-lookup"><span data-stu-id="7d903-130">A short-term solution to getting the current user's identity in code that hasn't yet been updated to work with ASP.NET Core's DI-driven architecture would be:</span></span>

  * <span data-ttu-id="7d903-131">Haga que `IHttpContextAccessor` esté disponible en el contenedor de DI llamando a [AddHttpContextAccessor](https://github.com/aspnet/Hosting/issues/793) en `Startup.ConfigureServices`.</span><span class="sxs-lookup"><span data-stu-id="7d903-131">Make `IHttpContextAccessor` available in the DI container by calling [AddHttpContextAccessor](https://github.com/aspnet/Hosting/issues/793) in `Startup.ConfigureServices`.</span></span>
  * <span data-ttu-id="7d903-132">Obtiene una instancia de `IHttpContextAccessor` durante el inicio y la almacena en una variable estática.</span><span class="sxs-lookup"><span data-stu-id="7d903-132">Get an instance of `IHttpContextAccessor` during startup and store it in a static variable.</span></span> <span data-ttu-id="7d903-133">La instancia de se pone a disposición del código que antes recuperaba el usuario actual de una propiedad estática.</span><span class="sxs-lookup"><span data-stu-id="7d903-133">The instance is made available to code that was previously retrieving the current user from a static property.</span></span>
  * <span data-ttu-id="7d903-134">Recupere el `ClaimsPrincipal` del usuario actual mediante `HttpContextAccessor.HttpContext?.User`.</span><span class="sxs-lookup"><span data-stu-id="7d903-134">Retrieve the current user's `ClaimsPrincipal` using `HttpContextAccessor.HttpContext?.User`.</span></span> <span data-ttu-id="7d903-135">Si este código se usa fuera del contexto de una solicitud HTTP, el `HttpContext` es NULL.</span><span class="sxs-lookup"><span data-stu-id="7d903-135">If this code is used outside of the context of an HTTP request, the `HttpContext` is null.</span></span>

<span data-ttu-id="7d903-136">La última opción, el uso de una instancia de `IHttpContextAccessor` almacenada en una variable estática, es contraria a los principios ASP.NET Core (la preferencia de dependencias insertadas a dependencias estáticas).</span><span class="sxs-lookup"><span data-stu-id="7d903-136">The final option, using an `IHttpContextAccessor` instance stored in a static variable, is contrary to ASP.NET Core principles (preferring injected dependencies to static dependencies).</span></span> <span data-ttu-id="7d903-137">En su lugar, planee recuperar `IHttpContextAccessor` instancias de la inserción de dependencias.</span><span class="sxs-lookup"><span data-stu-id="7d903-137">Plan to eventually retrieve `IHttpContextAccessor` instances from dependency injection instead.</span></span> <span data-ttu-id="7d903-138">Sin embargo, una aplicación auxiliar estática puede ser un puente útil a la hora de migrar aplicaciones de ASP.NET grandes existentes que usaban anteriormente `ClaimsPrincipal.Current`.</span><span class="sxs-lookup"><span data-stu-id="7d903-138">A static helper can be a useful bridge, though, when migrating large existing ASP.NET apps that were previously using `ClaimsPrincipal.Current`.</span></span>
